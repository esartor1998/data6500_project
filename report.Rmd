---
title: "Report"
author: "Eric Sartor"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage[numbers,sort&compress]{natbib}
  - \usepackage{setspace}\doublespace
  - \usepackage{url}
  - \DeclareMathOperator{\norm}{norm}
output: bookdown::pdf_document2
bibliography: bibliography.bib
csl: ieee.csl
link-citations: true
---

# Introduction

## Description of the Plague

  The Second Pandemic, otherwise known as the Black Death, played a key role in the shaping of late Medieval Europe and the world as we know it today. A devastating disease, known in historical sources simply as "plague" or "plagas", killed 40% of Europe's population just between 1347 and 1352 @Jedwab.etalPandemicsPlacesPopulations2019, and which continued to afflict Europe in waves until the 19th century. The bacterium responsible for the disease, *Yersinia pestis*, can cause 3 forms of plague in humans, all of which present at first with common flu symptoms. Bubonic plague, the most common outcome of infection @EvansPneumonicPlagueIncidence2022, with the most spectacular presentation of this form being painful, blackened, and swollen lymph nodes known as buboes. While mortality resulting from the bubonic form is only moderate, untreated bubonic plague may also develop into one of the other two forms of the disease @WorldHealthOrganizationPlague. Pneumonic plague, the second most common form of the disease, occurs when the lungs become infected; symptoms commonly include chest pain, shortness of breath, and the coughing of blood. This form is nearly 100% fatal, becoming untreatable even to modern medicine within 24-36h of the onset of symptoms. While other forms of the disease have an incubation period of 2-8 days, onset of symptoms for the pneumonic form can be within as little as 24 hours of infection @A.D.A.M.Inc.Plague, with death following shortly thereafter @Pechous.etalPneumonicPlagueDarker2016. The rarest form of plague, septicemic, results when *Yersinia pestis* multiplies in the blood. Uniquely, this variant causes the necrosis of tissues, and internal organ failure. While in modern times it may be curable with antibiotics if caught early enough, in the Middle Ages, it shared pneumonic plague's certain mortality.
  
  The disease is spread most commonly through the bite of an infected rat flea, though it can also be spread in its pneumonic form from person-to-person @WorldHealthOrganizationPlague. Evidence also indicates that human fleas can also be a vector for the disease, and can both receive it from and transmit it to humans @Hufthammer.WalloeRatsCannotHave2013, with SIR modeling demonstrating that a model based on transmission through human ectoparasites is similar in fit to one based on transmission through rat fleas [@Dean.etalHumanEctoparasitesSpread2018; @Sichone.etalEstimatingBasicReproduction2020]

  The recent digitization of a substantial volume of plague records @Buntgen.etalDigitizingHistoricalPlague2012 alongside new fine-grained population estimate rasters for pre-census periods through the HYDE project @kleingoldewijkAnthropogenicLandUse2017 allow for a myriad of novel analysis of the Second Pandemic. Through analysis of the characteristics and traits of the disease in a time when effective medical treatment for most diseases was completely unknown, further knowledge regarding societal responses to disease as well as the effect of unchecked disease on a population can be studied. Additionally, knowledge of the true severity of the disease throughout various regions of Europe can help to provide historical context for events and developments in the region throughout the Middle Ages. Furthermore, given the severity and gruesome nature of the disease, modelling its spread through and impact upon Medieval Europe may prove a sobering reminder of the potential severity of an incurable epidemic. 
  Therefore, the objective of this model is to attempt to model the yearly local impact of the Black Death throughout the whole of Europe, and in doing so to estimate crucial geographic characteristics of the epidemic. 

## Data Sources

* A digitized plague mentions dataset, including both mentions and well-known maritime trade routes @schmidSourceCodeDatasets2015 compiled for the paper "Climate-driven introduction of the Black Death and successive plague reintroductions into Europe" @schmidClimatedrivenIntroductionBlack2015
* HYDE 3.2 @kleingoldewijkAnthropogenicLandUse2017, a monumental collection of rasters, encoding global environmental conditions and other information, including the most recent historical population and population density estimates currently available for pre-census periods. The rasters are available in 100-year intervals during the period of interest, at a resolution of 85km$^2$.
* Approximate European borders shapefile for the year 1279 from a ThinkQuest educational web-site design competition held in 2000 @ThinkQuestTeamC006628TeachingHistoryGIS2000. While this data is entirely student-created and may present minor inaccuracies, as it is used simply for the purposes of aiding in visualization, this is not a major concern.
* Basemap tilesets for visualization by Apple, through `tmaptools` @TennekesTmapThematicMaps2018


```{r setup, include=FALSE, echo=FALSE}
library(sf)
library(sp)
library(maptools)
library(terra)
library(tidyverse)
library(osmdata)
library(tmap)
library(tmaptools)
library(rjson)
library(spatstat)
library(raster)
library(utils)
#some "important" "globals" and setup
#NOTE: much of this code is reused from my EDA/presentation code, with large
#chunks cut out of it because they weren't necessary to do in this report
tmap_mode('plot')
projected_crs = 'EPSG:3857'
unprojected_crs = 'EPSG:4326'

unproj_bbox = bbox = st_bbox(c(xmin = -16.26,
                 xmax = 42.98,
                 ymin = 27.92,
                 ymax = 61.54),
                 crs=unprojected_crs) %>%
       st_as_sfc()

bbox = unproj_bbox %>%
       st_transform(projected_crs)

cropping_bbox = vect(bbox)
up_cbbox = vect(unproj_bbox)

milan_location = st_point(c(45.4643, 9.189), dim='XY') %>%
                 st_sfc() %>%
                 as_Spatial()
crs(milan_location) = 'EPSG:3857' #NOTE: this is specifically in web mercator proj.

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
```


```{r downloadAndPrepData, echo=FALSE, include=FALSE}
basemap = read_osm(bbox, type='apple-iphoto', mergeTiles=TRUE)
#should maybe project these too if i go back to that

download.file('https://a.scrunko.monster/ZIwO3/HEhiticO76.csv/raw',
              './combined-maritime-traderoutes.csv')
maritime_routes_sf = read_sf('./combined-maritime-traderoutes.csv')
st_crs(maritime_routes_sf) = unprojected_crs
maritime_routes_sf = st_transform(maritime_routes_sf, unprojected_crs) %>%
                     st_crop(unproj_bbox)

download.file('https://github.com/kgjenkins/tq-world-historical-boundaries/raw/master/1279.zip', 
              './1279_borders.zip') #download directly from an archive, as streaming from my server
                                    #crashes on windows (i think some sort of php bug on the serv.)
                                    #note: make sure to cite this archive in the bibliography!! 
unzip('./1279_borders.zip')
borders = read_sf('./cntry1279.shp')
st_crs(borders) = unprojected_crs
borders = st_transform(borders, unprojected_crs) %>%
          st_crop(unproj_bbox)

download.file('https://a.scrunko.monster/ZIwO3/Lanidubi78.asc/raw',
              './popc_1300AD.asc')
ad1300_popc_rast = rast('./popc_1300AD.asc') %>%
                   terra::project(unprojected_crs) %>%
                   crop(up_cbbox) #%>%

units(ad1300_popc_rast) = 'ppl/cell'

download.file('https://a.scrunko.monster/ZIwO3/mIMuROme20.asc/raw',
              './popd_1300AD.asc')
ad1300_popd_rast = rast('./popd_1300AD.asc') %>%
                   terra::project(unprojected_crs) %>%
                   crop(up_cbbox)

units(ad1300_popd_rast) = 'ppl/kmÂ²'

download.file('https://a.scrunko.monster/ZIwO3/CAYoYISe01.asc/raw',
              './popc_1400AD.asc')
ad1400_popc_rast = rast('./popc_1400AD.asc') %>%
                   terra::project(unprojected_crs) %>%
                   crop(up_cbbox)

units(ad1400_popc_rast) = 'ppl/cell'

download.file('https://a.scrunko.monster/ZIwO3/RiBOJiMa99.txt/raw',
              './plague-db-europe.txt')

death_raster = ad1400_popc_rast - ad1300_popc_rast
```


```{python processPlagueInfo, echo=FALSE}
import re
import os

if not (os.path.exists('./plague_reprocessed.json')):
  with open('./plague-db-europe.txt', 'r') as plague_data:
    plague_data_text = plague_data.read()
    processed = re.sub(r'\:([a-zA-Z]+)', r'"\1":', plague_data_text)
    processed = re.sub(r'} ', r'}, ', processed)
    with open('./plague_reprocessed.json', 'w') as outfile:
      n = outfile.write(processed)
      outfile.close()
```


```{r readPlagueInfo, echo=FALSE}
library(jsonlite)
library(readr)

json_raw   = readr::read_file("./plague_reprocessed.json")
json_lines = unlist(strsplit(json_raw, "\\n"))
plague_df = do.call(rbind, lapply(json_lines, #god what a hack
                                  FUN = function(x){as.data.frame(jsonlite::fromJSON(x))})) 
plague_sf = st_as_sf(x=plague_df, 
                        coords=c('lon', 'lat'),
                        crs=unprojected_crs)

plague_occurrence_ordered = plague_sf[order(plague_sf$name, plague_sf$year, decreasing=FALSE),]
plague_occurrences_by_year = plague_occurrence_ordered %>%
                            group_by(year) %>%
                            arrange(year)

first_occurrences = plague_occurrences_by_year[!duplicated(plague_occurrences_by_year$name),] %>%
                    rename(first_occurrence = year) %>%
                    data.frame() %>%
                    subset(select=-c(geometry, source))

plague_occurrences_by_year = merge(plague_occurrences_by_year, first_occurrences, by='name')

target_occurrences = plague_occurrences_by_year[which(plague_occurrences_by_year$year <= 1400),]

#thanks to baseR for the following function actually
target_occurrences['is_reoccurrence'] = duplicated(target_occurrences$name)
occurrence_count = as.data.frame(table(target_occurrences$name))
occurrence_count = rename(occurrence_count, name = Var1)
target_occurrences = merge(target_occurrences, occurrence_count, by='name', all.x=T) %>%
                          rename(n_occurrences = Freq)
#only interested in years before 1400 right now

target_occurrences = st_as_sf(target_occurrences) %>% 
                    st_crop(unproj_bbox) %>%
                    arrange(year)

all_target_years = target_occurrences[which(target_occurrences$year <= 1400),]
```


```{r garbageCollection, echo=FALSE, include=FALSE}
#just to clean up exec environment of tempvars. 
#ik if i used more piping i wouldnt have to do this, but i don't care atm
rm(plague_occurrence_ordered)
rm(plague_occurences_by_year)
rm(occurrence_count)
rm(target_occurrences)
rm(plague_df)
rm(plague_sf)
rm(json_raw)
rm(json_lines)
```


# Methods

## Preliminary Work Motivating the Model

  Unless otherwise specified, all analyses were performed using the R language @RCoreTeamLanguageEnvironmentStatistical2023. 
Firstly, a raster containing the population difference between 1300AD and 1400AD was computed. This raster, visible in Figure \@ref(fig:deathRaster), is variously referred to in this report as the "death raster", or "population difference raster". It represents the loss or gain in population count in each cell over the 14th century as estimated by the HYDE. One would normally expect wholesale population growth, but as a result of the devastation wrought by the Second Pandemic, the population difference raster is mostly negative, with population gain generally only in more remote regions. 
As a result of this, and given the generally small magnitude of the population gain, a model purely estimating deaths rather than attempting to include population gain as well was used to massively simplify the required calculation.

  Next, in order to assess sanity of the outbreak data, as well as its correlation with the HYDE estimates, Poisson point process methods were used to generate an intensity (points per unit area) estimate for the outbreak data as a function of the death raster. Specifically, the outbreak data preceding 1400AD was interpreted as a single Poisson point process, and a nonparametric intensity estimate was taken through `spatstat`'s `rhohat` function @Baddeley.etalHybridsGibbsPoint2013. Then, a raster was computed depicting the predicted intensity at every cell in the death raster, resulting in Figure \@ref(fig:predictedIntensityThroughRhohat). This informed the usage of the outbreak data in general, providing confidence that it was correlated with deaths. Further, some authors cast doubt upon the usefulness of the Schmid et al. data, stating that it may be missing key outbreaks in Europe, as the intensity of the points in Northern Italy in their opinion did not align with other historical accounts @roosenDangersNoncriticalUse2018. This nonparametric analysis, however, finds a high intensity in the allegedly problematic regions, providing confidence that the usage of the outbreak data is not detrimental to the legitimacy of any results.

  Additionally, it is significant that the death raster is quite similar to the population density raster for the year 1300AD, as the population difference raster is generated only using population count data: this explicitly points to population density as a key factor in the relationship. In order to further assess the nature of the relationship between population density and population difference, focal correlation between the two rasters was assessed using the `focalPairs` function available through `terra` @HijmansRasterGeographicData2023, and is visible in Figure \@ref(fig:focalCorrelationBetweenDeathsAndPopd).


## Deterministic Model

  The model seeks to simulate the yearly impact of the plague per cell in Europe between the years 1300AD and 1400AD, using grid search to tune its hyperparameters. It runs on each outbreak year chronologically, generating rasters for every year that at least one plague outbreak is recorded in historical sources (in practice, this is every year between 1346AD and 1400AD). To assess how successful it has been in its estimation, it compares the final values it arrives at for the living population of Europe in 1400AD with those from the HYDE estimate for that year, as well as the sum of all yearly death estimates it has made with the population difference raster. This report will refer to the individual results generated through each comparison as a "submodel", and the methodology as a whole as the "model" or "system". Each submodel generates Pearson correlation coefficient values between its estimates and those made by the far more sophisticated HYDE, and chooses the set of hyperparameters which result in the greatest correlation.
  While technically a recursive algorithm, it is not implemented as such in order to save resources during processing. All generated rasters are identical in dimension to the population density and count rasters obtained through the HYDE, and no downscaling is performed. Additionally, all calculations are performed on unprojected data, as `terra`'s `distance` function is significantly more accurate with unprojected data than on projected data. 

  Firstly, the outbreak points for ${year}$ are taken, and a raster $dist_{rast}$ is computed where the value of each pixel is inversely proportional to their distance from the closest outbreak according to $h = \exp({-m\norm{(ad^{x})}})$, where $d$ is the closest distance to an outbreak point returned for each pixel by `terra`'s `distance` function. $m$ $a$ and $x$ are scaling parameters for which various values are tested: $m$ scales the largest negative value that $e$ can be raised to, $a$ increases the area underneath the curve close to the $y$ axis by "lifting" the graph upwards, and $x$ disproportionately increases the value returned for pixels extremely close to the closest outbreak point. Effectively, $m$ and $a$ scale the overall range of an outbreak's effect, while $x$ scales the distance where the outbreak will be the most devastating. The $\norm{}$ function represents the uniform scaling, or normalization, of the raster's cell values to between 0.0 and 1.0, and is defined by $\frac{x - \min{(x)}}{\max{(x)} - min{(x)}}$.

  Before describing how the estimated infected population raster is calculated, it is imperative to define several other rasters as well. The susceptible population density raster, $dens_{rast}$, wherein each cell's value represents the density of susceptible individuals within any given cell. The initial value of $dens_{rast}$ is the population density in 1300AD. The susceptible population *density* raster is recalculated each year based upon $S_{rast}$, the susceptible population *count* raster. The initial value of this raster is the population count in 1300AD.

  Next, the infected population estimate raster $I$ is calculated, by $s(dens_{rast})(dist_{rast})$. The density and distance rasters are multiplied together, cell-by-cell, as well as by a normalized scalar parameter, $s$, representing the maximal yearly saturation percentage within susceptible individuals; this value is tested multiple times between 0.0 and 1.0. $s$ exists as according to current scholarship, even the cities hit most severely with plague only lost at most 50-80% of their populations [@CohnEpidemiologyBlackDeath2008; @DorseyArmstrongHowPolandMilan2021; @Cesana.etalOriginEarlySpread2017; @Roosen.CurtisLightTouchBlack2019; @Jedwab.etalPandemicsPlacesPopulations2019]. While it may be intuitive, it still must be noted that $I$ is instantaneous, and does not represent cumulative infections, only the number of infections in the outbreak year currently being analysed.
It is also crucial to note that $dens_{rast}$ is not normalized, thus cells with a high density of susceptible individuals will be struck most severely with plague. However, because the susceptible population density is adjusted each iteration, this is seen most acutely when the area experiences its first outbreak. Additionally of note is that the value of $dist_{rast}$ approaches 0 at an exponential rate with distance to a recorded outbreak, allowing the progression of the disease to roughly follow the point pattern present in the outbreaks dataset, and for the countryside to be less severely affected than denser, more urban areas where outbreaks are typically recorded.

  The final step each iteration is to adjust each population, as well as the population density, before recursing. This series of steps is more complex than it may at first seem, and is thus broken into several paragraphs to ease reading. Firstly, $I$ is subtracted from $S$, as a person cannot be reinfected with any form of the plague, either because they have died, or because they have become immune to all forms after surviving an infection. 
  
  Following this, the newly modified $S$ is utilized to create a new $dens_{rast}$ for the next iteration. However, this is not straightforward: even though the data is unprojected, the ellipsoid indexed by the longitude and latitude coordinates is not perfectly spherical and is instead flatter about the poles. Thus, some cells represent a larger actual area than others, and the true geographic area represented needs to be determined so that the population density is not skewed positively towards flattened areas. Luckily, `terra`'s `cellSize` is a quick and effective way to obtain the true geographic size of a raster cell, provided that it is sufficiently small. However, this alone still does not perfectly convert population to population density, as the HYDE uses other sources in addition to population count to gauge population density. As a result, we also need to offset each population count-to-density conversion by the difference between 1300AD population density calculated using only 1300AD population count, and the 1300AD HYDE estimate for population density. Put mathematically, the offset raster is calculated through $b = \frac{count_0}{size_0} - dens_0$, where $count_0$ is the population count raster in 1300AD, $size_0$ represents the raster of cell sizes obtained with `terra` for all cells in that raster, and $dens_0$ represents the population density estimate for 1300AD. This offset raster only needs to be evaluated one time, for the year 1300AD, as it acts as a global adjustment to each subsequent year's $dens_{rast}$ values. Further, the function used to convert population count to population density could be expressed as $\frac{count}{size}-b$, where $count$ is the population count raster, $size$ is the calculated raster containing $counts$ cell sizes, and $b$ is the previously-calculated offset.
  
  With all this complete, $I$ is multiplied by $mortality$ in order to approximate the number of those infected who will die; for this simulation, the scalar value $0.8 = mortality$ is used. This 80% mortality rate is based upon various estimates of the average contemporary mortality across all forms of the disease [@Pechous.etalPneumonicPlagueDarker2016; @EvansPneumonicPlagueIncidence2022; @Dean.etalHumanEctoparasitesSpread2018; @TotaroSufferingParadiseBubonic2005; @CohnEpidemiologyBlackDeath2008]. $mortality$ was initially tested with multiple values, but as it seemed have very little impact upon the result, and greatly expanded the search space, it was instead set to a scalar value to save computation time. In any case, the resulting raster, $D$, represents only the dead individuals from the outbreak year currently being analysed, *not* the cumulative number of deaths over the entire epidemic, as it is based on the instantaneous $I$. All yearly $D$ rasters must be summed at the end of recursion in order to compute a total estimate. $R$, or the raster of recovered individuals for the year, is also calculated by $I - D$.

  The algorithm is run until final year is reached. Then, all rasters $D$ and $R$ are summed respectively to $D_{total}$ and $R_{total}$, estimates for the total number of deaths and recoveries per cell over the entire 14th century. The correlation between these approximations and the values estimated in the HYDE are also computed. In the case of the estimated death number, correlation is measured against the inversely-signed population difference raster, as deaths in that raster are represented by a negative number, but this model can only produce positive numbers. The correlation between the population count in 1400AD and the model's final population estimate raster $A$, which is computed by $A = S_{final} + R_{total}$, is also tracked. The grid search is run to completion, with all unique combinations of the $m$, $a$, $x$, and $s$ parameters, and the submodel correlations between expected and actual values for both deaths and population are selected and displayed, visible in Figure \@ref(fig:topCorrelationChartD), and in Figure \@ref(fig:topCorrelationChartA). The predicted 1400AD rasters for deaths and remaining population are Figure \@ref(fig:bestModelResultD) and Figure \@ref(fig:bestModelResultA), respectively, with the HYDE estimates side-by-side for comparison. Additionally, snapshots of key years of the epidemic as predicted in the best deaths submodel are also included in Figure \@ref(fig:keyYearDeaths) within the non-technical summary.


```{r deathRaster, echo=FALSE, fig.cap='The Population Difference Raster, or "Death Raster"', out.height='70%'}
tm_shape(basemap) + tm_rgb(alpha = 0.8) + tm_shape(death_raster, raster.downsample=FALSE) + tm_raster(alpha=0.7,
                                                                  breaks=c(-51200.0
                                                                          -25600.0,
                                                                          -12800.0,
                                                                          -6400.0,
                                                                          -3200.0,
                                                                          -1600.0,
                                                                          -800.0,
                                                                          -400.0,
                                                                          -200.0,
                                                                          -100.0,
                                                                            0.0,
                                                                           100.0,
                                                                           200.0,
                                                                           400.0,
                                                                           800.0,
                                                                           1600.0),
                                                                  title='') +
        tm_shape(borders$geometry) + tm_borders(alpha=0.5) +
        tm_layout(legend.position=c('left', 'top'),
                  frame=FALSE,
                  legend.outside=TRUE,
                  legend.bg.alpha=0.6,
                  main.title='Pop. Diff 1400AD-1300AD')
```


# Results

## Preliminary Work Results

  While the resultant models themselves are the key focus of this report, the preliminary work also yielded some interesting results worthy of discussion. The focal correlation plot generated for Figure \@ref(fig:focalCorrelationBetweenDeathsAndPopd) is primarily reassuring due to the large swathe of reasssuringly negatively correlated space, however the areas which are positively correlated are also interesting and point to additional conclusions that can be gleaned from the data. Major cities of such as Paris, Berlin, and Vienna are counterintuitively strongly *positively* correlated with population difference. In other words: despite being dense urban areas, they seemed to experience relative growth in contrast to other major cities of the time which were strongly negatively correlated, like London, Munich, or Milan. This could point to a pattern of migration into urban areas from less-affected rural communities as a result of the severe and abrupt population shock [@DorseyArmstrongHowPolandMilan2021; @Siuda.SundeDiseaseDemographicDevelopment2021; @Jedwab.etalPandemicsPlacesPopulations2019]. This phenomenon is of immense interest to anthropologists, especially those interested in human movement and the dramatic societal and cultural shifts that manifested in the regions where this positive correlation is present shortly after the most devastating years of plague had passed @A.D.A.M.Inc.Plague. Unfortunately, the methods utilized in this paper are not robust enough to make predictions about this phenomenon, though it presents a promising avenue for future work. 


```{r focalCorrelationBetweenDeathsAndPopd, echo=FALSE, fig.cap='Pop. Dens. and Pop. Diff. Spatial Focal Correlation', out.height='70%'}
death_on_popd = rast(list(ad1300_popd_rast, death_raster))
crs(death_on_popd) = unprojected_crs
correlation = focalPairs(death_on_popd, w = 3, cor) #WARNING: this may crash if your libraries are not up-to-date!

tm_shape(basemap) + tm_rgb(alpha=0.8) + tm_shape(correlation, raster.downsample=FALSE) +
  tm_raster(alpha=0.7, palette='Spectral', title='') + 
  tm_shape(borders$geometry) + tm_borders(alpha=0.5) + 
  tm_layout(legend.position=c('left', 'top'),
            frame=FALSE, 
            legend.bg.alpha=0.6,
            legend.outside=TRUE,
            main.title="Focal Correlation Between\nDeaths and 1300AD Pop. Dens.")
```


```{r predictedIntensityThroughRhohat, echo=FALSE, fig.cap='Nonparametric Estimate of Intensity as a Function of Pop. Dens.', out.height='70%'}
#first we gotta project the data. I'm choosing ED1950 Albers, as it covers the target area decently
death_raster_proj = death_raster %>%
                    terra::project(projected_crs)

death_raster_im = death_raster_proj %>%
                  raster() %>%
                  as.im.RasterLayer()

target_years_proj = all_target_years %>%
                    st_transform(projected_crs)

outbreak_ppp = target_years_proj %>%
              dplyr::select(is_reoccurrence, year) %>%
              mutate(year=factor(year)) %>%
              mutate(is_reoccurance=factor(is_reoccurrence)) %>%
              as.ppp()

rh = rhohat(outbreak_ppp, death_raster_im)

predrast = rast(predict(rh)*10e8) #many values are very small
crs(predrast) = projected_crs
tm_shape(basemap) + tm_rgb(alpha=0.8) + tm_shape(predrast, raster.downsample=FALSE) +
                                        tm_raster(alpha=0.7,
                                                  breaks = c(0,0.05,0.1,0.15,0.2,0.25,0.3,0.35), 
                                                  palette = 'Spectral',
                                                  title = 'Intensity') +
  tm_shape(borders$geometry) + tm_borders(alpha=0.5) + 
  tm_layout(legend.position=c('left', 'top'),
            frame=FALSE,
            legend.outside=TRUE,
            main.title='14th Century Predicted Intensity')
```


```{r runSimulations, echo=FALSE, include=FALSE}
#scaling for raster cells is spatially warped:
popc_cell_size = terra::cellSize(ad1300_popc_rast, unit='km')
#cell size shouldn't change, so we only need to do this one time
#additionally, wemust offset here, as the data used to obtain popd uses more sources than just popc
popd_offset = (ad1300_popc_rast / popc_cell_size) - ad1300_popd_rast
#so, we need to generate an offset raster representing the initial starting offset from 
#popc/cellsize present in the data, and then apply that retroactively going forward in the conv.

normalize_rast = function(rast) {
  m = terra::minmax(rast) #m[1] is min, m[2] is max
  return((rast - m[1])/(m[2] - m[1]))
}

popc2popd = function(popc_rast) {
  return((popc_rast / popc_cell_size) - popd_offset)
} #subtracting 1300_popd is valid, as that is the last known offset to the true number

year2idx = function(year) {
  return(which(recorded_years == year))
} #convenience function for converting a year number to its results-index


#TUNEABLE PARAMETERS:
target_years = all_target_years[which(all_target_years$year > 1345 &
                                      all_target_years$year <= 1400),]
recorded_years = unique(target_years$year)
first_year = recorded_years[1]

d_smoothing = c(0.3, 0.7) #size of the region extremely close to 1.0 in distance raster

d_coeff =     c(2, 50) #adjusts the overall region above d_threshold in distance raster

d_max_range = c(3, 6, 12)

worst_case =  c(0.75, 0.9) #estimated maximum yearly saturation % of infection among S

#non-tuned params:
d_threshold = 0.01 #value at which we would like to round to 0, to prevent global infection
mortality   = 0.8 #@TotaroSufferingParadiseBubonic2005

params = crossing(d_smoothing, d_coeff, d_max_range, worst_case)
iter=0
best_so_far_D = 0
dead_maps = list()
final_dead = list()
final_alive = list()
final_susc = list()
correlations_A = list()
correlations_D = list()
correlations_P = list()
for (trial in split(params, seq(nrow(params)))) {
  iter = iter + 1
  susceptible = list()
  infected = list()
  recovered = list()
  dead = list()
  susd = list()
  maps = list()
  for (year in recorded_years) {
    curr_idx = year2idx(year) #NOT: not the idx in targ_years, just iter#
    prev_idx = curr_idx - 1
  
    prev_years_outbrks = target_years[which(target_years$year <= year),]
    curr_year_outbrks = target_years[which(target_years$year == year),]
  
    #the variable we will use to hold this year's susceptible population estimate raster
    susc_tmp = if(length(susceptible) == 0) ad1300_popc_rast else susceptible[[prev_idx]]
    
    #the variable we will use to hold this year's S population density estimate raster
    susd_tmp = normalize_rast(
      if(length(susd) == 0) ad1300_popd_rast else susd[[prev_idx]]
    )
  
    #the raster used to scale distance from an outbreak
    dist_rast = exp(1)^(-(trial$d_max_range) * normalize_rast(
      trial$d_coeff*terra::distance(susc_tmp, vect(curr_year_outbrks), rasterize=T)^trial$d_smoothing
    ))
    dist_rast[dist_rast < d_threshold] = 0
    
    #the "infectiousness raster" we can use as a term in our estimate of the number of dead/infected
    infn_rast = trial$worst_case * dist_rast * susd_tmp
    
    #the estimate of the infected. should i use terra::predict, or...?
    infected[[curr_idx]] = floor(infn_rast * susc_tmp)
    #and, the other values associated:
    susceptible[[curr_idx]] = susc_tmp - infected[[curr_idx]] #even if survived, cant be reinfected
    #recovered, dead aren't cumulative like S is
    dead[[curr_idx]] = mortality * infected[[curr_idx]]
    recovered[[curr_idx]] = infected[[curr_idx]] - dead[[curr_idx]] 
    
    #we musn't forget to also adjust the susceptible population density
    susd[[curr_idx]] = popc2popd(susceptible[[curr_idx]])
    
    maps[[curr_idx]] = tm_shape(basemap) +
                    tm_rgb(alpha=0.8) +
                    tm_shape(dead[[curr_idx]], raster.downsample=F) +
                    tm_raster(alpha=0.7, 
                              breaks=c(0.0,
                                       10.0,
                                       20.0,
                                       40.0,
                                       80.0,
                                       160.0,
                                       320.0,
                                       640.0,
                                       1280.0,
                                       2560.0,
                                       5120.0,
                                       10240.0), title="Deaths in Area") +
                    tm_shape(borders$geometry) + tm_borders(alpha=0.5) +
                    tm_layout(legend.position=c('right', 'center'),
                              frame=FALSE,
                              title.snap.to.legend = T,
                              legend.outside=TRUE,
                              legend.outside.position='left',
                              main.title.size = 2.4,
                              legend.text.size = 2.4,
                              legend.title.size = 2.4,
                              main.title.position='center',
                              main.title=paste0(year,'AD Death Prediction'))
  }
  final_dead[[iter]] = terra::app(rast(dead), sum)
  final_susc[[iter]] = susceptible[[curr_idx]] #each element of S is a cum. tot., unlike D
  final_alive[[iter]] = susceptible[[curr_idx]] + terra::app(rast(recovered), sum)
  correlations_A[[iter]] = cor(terra::values(ad1400_popc_rast),
                           terra::values(final_alive[[iter]]), 
                           use="complete.obs")
  correlations_D[[iter]] = cor(terra::values(-death_raster),
                           terra::values(final_dead[[iter]]), 
                           use="complete.obs")
  correlations_P[[iter]] = cor(terra::values(ad1400_popc_rast),
                           terra::values(final_susc[[iter]]), 
                           use="complete.obs")
  
  if (correlations_D[[iter]] > best_so_far_D) {
    dead_maps = rep(maps, 1) #get copied lawl
  }
  
  print(paste('trial',iter,'complete'))
}
```


## Deterministic Model Results

  Despite its relative simplicity, the deterministic models perform extremely well on this data. With a very strong correlation coefficient between the submodel-estimated population and that estimated by the HYDE, we can be confident that at least against the HYDE 3.2 data, predictions are fairly accurate. The death submodel estimation, while slightly less correlated with the HYDE prediction, is still decently accurate. However, the system's overreliance on self-verification using those estimates is also a significant weakness of the system; in the future, it would be prudent to test against other estimates of population and population decline, even simply testing the population of cities against what is reported by other historical sources. Any inaccuracy in the initial population or density, for example, could lead to sweeping inaccuracies in the predicted results.
  
  It is interesting that the preferred set of hyperparameters differs between the population count and deaths. This may also be the result of a dearth of adequate parameters in the system. Because deaths and surviving population are two sides of the same coin, linked mathematically through the system of equations $A = R + S, R = I - D, D = mortality \times I$, it seems fairly intuitive that adding at the very least a hyperparameter for $mortality$ instead of having it as a constant value would likely help to remedy this issue. Furthermore, some plague models [@Dean.etalHumanEctoparasitesSpread2018; @Sichone.etalEstimatingBasicReproduction2020; @Nguyen.etal2017PlagueOutbreak2018] add differing mortality and infection rates for various forms of the disease, as well as the capability to transition between these states. Factoring that information in would certainly would be a key step towards more accurate and realistic modelling. Unfortunately, doing so would preclude the continued usage of grid search to tune the parameters, as it would necessitate the addition of a huge swathe of new hyperparameters, likely skyrocketing the required computational time for this method far, far into the realm of infeasability.
  
  As population increases, both correlation plots seem to diverge into two pathways, one in which my estimates are too high, and one in which they are too low. This seems to indicate that the current set of parameters this system applies to the data is not adequate, and that there are other factors which are unaccounted for. Because the largest factor influencing the magnitude of infections in any given cell is population density, and because this effect seems to intensify as the magnitude of the prediction increases, modifying the effect or values of the yearly $dens_{rast}$ may be dampen this divergence. Indeed, in this system $dens_{rast}$ is considered fairly directly as a proxy for the number of contacts between individuals (the crucial factor in how many individuals one person may infect). This may not be a valid assumption to make, and instead first predicting the frequency and magnitude of contacts *using* the $dens_{rast}$ as performed by Hu et al. @Hu.etalScalingContactRates2013 (or perhaps even a slightly simpler model) may lead to far more precise predictions.
  
  Given the relative accuracy of the models, especially in higher-density areas, attention must be drawn instead to areas where the models lack accuracy. Ireland, Brittany, and particularly Southeastern Europe are all lacking some of the definition present in the HYDE 3.2 estimates. The deaths submodel in particular seems to have an excessively light hand in some rural areas, and an excessively heavy hand in some urban areas. While the latter point in particular may be explained easily by migration, all three points together suggest that there is an even larger current underlying issue. The most obvious conclusion would be that the relationship between the magnitude of infection in a cell depends on additional factors more complicated than simple $scalar \times{density} \times{distance}$. Some outliers, such as the grossly under-predicted point in Figure \@ref(fig:topCorrelationChartA) also suggest that the formula for $I$ is inadequate, and that a wider range of parameters encapsulating socioeconomic phenomenon such as the relationships between urban centers, and between these urban centers and their rural surroundings. Of course, as this data models the real world, and the potential that crucial data is lost to time, perfect accuracy may of course be a futile pursuit.


```{r topCorrelationChartA, echo=FALSE, out.height='80%', fig.cap='Most Correlated Population Model Estimated vs. Actual Plot'}
most_corr_idx_A = which.max(correlations_A)
plot(terra::values(final_alive[[most_corr_idx_A]]) ~ terra::values(ad1400_popc_rast),
     xlab = 'Actual Population',
     ylab = 'Expected Population')
abline(lm(terra::values(final_alive[[most_corr_idx_A]]) ~ terra::values(ad1400_popc_rast)))
legend("topleft", legend=paste0('Model #', most_corr_idx_A,
                               ' Final Alive Correlation = ', round(correlations_A[[most_corr_idx_A]], 2)))
```


```{r bestModelResultA, echo=FALSE, fig.cap='Comparison of 1400AD Population Estimate Rasters', fig.height = 27, fig.width = 20}
a_coll = list(tm_shape(basemap) +
  tm_rgb(alpha=0.8) +
  tm_shape(final_alive[[most_corr_idx_A]], raster.downsample=F) +
  tm_raster(alpha=0.7, 
            breaks=c(0.0,
                     100.0,
                     200.0,
                     400.0,
                     800.0,
                     1600.0,
                     3200.0,
                     6400.0,
                     12000.0,
                     24000.0,
                     48000.0), title="People in cell") +
  tm_shape(borders$geometry) + tm_borders(alpha=0.5) +
  tm_layout(legend.position=c('right', 'center'),
            frame=FALSE,
            title.snap.to.legend = T,
            legend.outside=TRUE,
            legend.outside.position='left',
            main.title.size = 2.4,
            legend.text.size = 2.4,
            legend.title.size = 2.4,
            main.title.position='center',
            main.title=paste0('1400AD Model #',most_corr_idx_A,' Pop. Count Estimate')),

  tm_shape(basemap) +
    tm_rgb(alpha=0.8) +
    tm_shape(ad1400_popc_rast, raster.downsample=F) +
    tm_raster(alpha=0.7, 
              breaks=c(0.0,
                       100.0,
                       200.0,
                       400.0,
                       800.0,
                       1600.0,
                       3200.0,
                       6400.0,
                       12000.0,
                       24000.0,
                       48000.0), title='People in cell') +
    tm_shape(borders$geometry) + tm_borders(alpha=0.5) +
    tm_layout(legend.position=c('right', 'center'),
              frame=FALSE,
              main.title.position='center',
              main.title.size = 2.4,
              legend.text.size = 2.4,
              legend.title.size = 2.4,
              legend.outside = T,
              legend.outside.position='left',
              main.title='HYDE 3.2 Prediction'))

tmap_arrange(a_coll[[1]], a_coll[[2]], ncol=1)
```


```{r topCorrelationChartD, echo=FALSE, fig.cap='Most Correlated Death Model Estimated vs. Actual Plot', out.height='80%'}
most_corr_idx_D = which.max(correlations_D)
plot(terra::values(final_dead[[most_corr_idx_D]]) ~ terra::values(-death_raster),
     xlab = 'Actual Population Decrease',
     ylab = 'Expected Population Decrease')
abline(lm(terra::values(final_dead[[most_corr_idx_D]]) ~ terra::values(-death_raster)))
legend("topleft", legend=paste0('Model #', most_corr_idx_D,
                               ' Final Death Correlation = ', round(correlations_D[[most_corr_idx_D]], 2)))
```


```{r bestModelResultD, echo=FALSE, fig.cap='Comparison of 1400AD Population Estimates', fig.height = 27, fig.width = 20}
d_coll = list(tm_shape(basemap) +
              tm_rgb(alpha=0.8) +
              tm_shape(final_dead[[most_corr_idx_D]], raster.downsample=F) +
              tm_raster(alpha=0.7, 
                        breaks=c(0.0,
                                 100.0,
                                 200.0,
                                 400.0,
                                 800.0,
                                 1600.0,
                                 3200.0,
                                 6400.0,
                                 12000.0,
                                 24000.0,
                                 48000.0), title="Deaths in cell", midpoint=0) +
              tm_shape(borders$geometry) + tm_borders(alpha=0.5) +
              tm_layout(legend.position=c('right', 'center'),
                        frame=FALSE,
                        legend.outside=TRUE,
                        legend.outside.position='left',
                        main.title.position='center',
                        main.title.size = 2.4,
                        legend.text.size = 2.4,
                        legend.title.size = 2.4,
                        main.title=paste0('Model #',most_corr_idx_D,' Death Estimate')),
            
              tm_shape(basemap) +
                tm_rgb(alpha=0.8) +
                tm_shape(-death_raster, raster.downsample=F) +
                tm_raster(alpha=0.7, 
                          breaks=c(0.0,
                                   100.0,
                                   200.0,
                                   400.0,
                                   800.0,
                                   1600.0,
                                   3200.0,
                                   6400.0,
                                   12000.0,
                                   24000.0,
                                   48000.0), title="Deaths in cell",
                                              legend.is.portrait = T,
                                              midpoint=0) +
                tm_shape(borders$geometry) + tm_borders(alpha=0.5) +
                tm_layout(legend.position=c('right', 'center'),
                          frame=FALSE,
                          main.title.position='center',
                          legend.outside = T,
                          legend.outside.position='left',
                          main.title.size = 2.4,
                          legend.text.size = 2.4,
                          legend.title.size = 2.4,
                          main.title='HYDE 3.2 Prediction'))

tmap_arrange(d_coll[[1]], d_coll[[2]], ncol=1)
```


# Summary for Non-Technical Audiences

## Motivation

  The "Black Death" refers to the period in history between 1347 and 1352, where a devastating disease epidemic completely decimated the population of Western Europe. This event had a tremendous impact upon not just Europe, but the whole world. Recently, new and very high-quality data has been released that strives to portray demographic data like population far more accurately for than ever before. By using this new data in combination with knowledge of when and where outbreaks of plague were, we can try to predict how severely the epidemic impacted any location in Western Europe. This isn't just a thought exercise, either: by learning more about how the average person would have experienced this time in history, we can more easily understand the huge societal changes it brought about, and how something like this might affect us.
  
## Data Sources

  This new high-quality data is called the "HistorY Database for the global Environment", or HYDE for short @kleingoldewijkAnthropogenicLandUse2017. It was created by a team of scientists who are studying how the Earth and its climate have changed over time, and how people might be affecting that change. This new data has population counts and population density for all over Europe from just before the Black Death, as well as just after it. Another team of researchers has recently done a lot of work to compile historical references to plague outbreaks, and painstakingly put each one on a map for other researchers to use @schmidClimatedrivenIntroductionBlack2015.
  
## Methods

  Because we know how many people were living at any location in Europe, and we know how densely they were packed in, we can try to guess how many people would get sick if an outbreak of plague were to appear in that area. Since we also actually do know when and where outbreaks of plague *did* occur, we can simulate every year, guessing how many people who are sick, have died, or have recovered. Once we've reached the end of the Black Death period, we can go back and check how close our simulated years are to the real thing by looking at how the results of our simulations line up with the what the new high-quality data says things were like then. If it looks close, we must not be too far off the mark.
  
## Results

  The worst years of the plague were certainly pretty bad, according to the best predictions of our simulations. You can have a look for yourself in Figure \@ref(fig:keyYearDeaths). It seems like many people, especially those who lived in dense areas like cities didn't survive these years. In demographics, this is called a "population shock", and it usually results in huge societal changes.
  
## Limitations
  
  Just because we worked so hard to make our simulation doesn't mean that it's perfect: it relies very heavily on just a few sources, which can be dangerous. If anything is wrong in any of our sources, we will be wrong too. Also, our simulation aims to model the real world, but it does so using simple mathematics. The real world is very complicated, and things happen as a result of tons of interactions between many different variables. So, there are probably important things that our simulation doesn't take into account that might cause it to be inaccurate.
  
```{r keyYearDeaths, echo=FALSE, fig.cap='Yearly Deaths During the Worst Years of the Black Death', fig.height = 20, fig.width = 20}
#lawl
s_coll = list(dead_maps[[year2idx(1347)]],
              dead_maps[[year2idx(1348)]],
              dead_maps[[year2idx(1349)]],
              dead_maps[[year2idx(1350)]])

tmap_arrange(s_coll[[1]], s_coll[[2]], s_coll[[3]], s_coll[[4]], ncol=2, nrow=2)
```


# References


<br>
<div id="refs"></div>