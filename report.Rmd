---
title: "Report"
author: "Eric Sartor"
date: "`r Sys.Date()`"
output: pdf_document
bibliography: bibliography.bib
csl: ieee.csl
nocite: '@*'
---

## Introduction

### Description of the Plague

The Second Pandemic, otherwise known as the Black Death, played a key role in the shaping of late Medieval Europe and the world as we know it today. A devastating disease, known in historical sources simply as "plague" or "plagas", killed 40% of Europe's population just between 1347 and 1352 @jedwab_pandemics_2019, and which continued to afflict Europe in waves until the 19th century. The bacterium responsible for the disease, *Yersinia pestis*, can cause 3 forms of plague in humans, all of which present at first with common flu symptoms. Bubonic plague, the most common outcome of infection @evans_pneumonic_2022, with the most spectacular presentation of this form being painful, blackened, and swollen lymph nodes known as buboes. While mortality resulting from the bubonic form is only moderate, untreated bubonic plague may also develop into one of the other two forms of the disease @world_health_organization_plague_nodate. Pneumonic plague, the second most common form of the disease, occurs when the lungs become infected; symptoms commonly include chest pain, shortness of breath, and the coughing of blood. This form is nearly 100% fatal, becoming untreatable even to modern medicine within 24-36h of the onset of symptoms. While other forms of the disease have an incubation period of 2-8 days, onset of symptoms for the pneumonic form can be within as little as 24 hours of infection @noauthor_plague_nodate, with death following shortly thereafter @pechous_pneumonic_2016. The rarest form of plague, septicemic, results when *Yersinia pestis* multiplies in the blood. Uniquely, this variant causes the necrosis of tissues, and internal organ failure. While it is more treatable than pneumonic plague, in the Middle Ages, as no treatment was known for any form of the disease, it shared pneumonic plague's certain mortality. 
The disease is spread most commonly through the bite of an infected rat flea, though it can also be spread in its pneumonic form from person-to-person @world_health_organization_plague_nodate. Evidence also indicates that human fleas can also be a vector for the disease, and can both receive it from and transmit it to humans @hufthammer_rats_2013, with SIR modeling demonstrating that a model based on transmission through human ectoparasites is similar in fit to one based on transmission through rat fleas @dean_human_2018.
The recent digitization of a substantial volume of plague records @buntgen_digitizing_2012 alongside new fine-grained population estimate rasters for pre-census periods through the HYDE project @klein_goldewijk_anthropogenic_2017 allow for myriad novel analysis of the Second Pandemic. Through analysis of the characteristics and traits of the disease in a time when effective medical treatment for most diseases was completely unknown, further knowledge regarding societal responses to disease as well as the effect of unchecked disease on a population can be studied. Additionally, knowledge of the true severity of the disease various communities and s can help to provide historical context for events and developments in the Middle Ages.

### Data Sources

* A digitized plague mentions dataset, including both mentions and well-known maritime trade routes @schmid_source_2015 compiled for the paper "Climate-driven introduction of the Black Death and successive plague reintroductions into Europe" @schmid_climate-driven_2015
* HYDE 3.2 @klein_goldewijk_anthropogenic_2017, a monumental collection of rasters, encoding global environmental conditions and other information, including the most recent historical population and population density estimates currently available for pre-census speriods.
* Approximate European borders shapefile for 1279 from a ThinkQuest educational web-site design competition held in 2000 @thinkquest_citation_post_rework. While this data is entirely student-created and may present minor inaccuracies, as it is used simply for the purposes of aiding in visualization, this is not a major concern.


```{r setup, include=FALSE, echo=FALSE}
library(sf)
library(sp)
library(maptools)
library(terra)
library(tidyverse)
library(osmdata)
library(tmap)
library(tmaptools)
library(rjson)
library(spatstat)
library(raster)
library(utils)
#some "important" "globals" and setup
#NOTE: much of this code is reused from my EDA/presentation code, with large
#chunks cut out of it because they weren't necessary to do in this report
tmap_mode('plot')
projected_crs = 'EPSG:3857'
unprojected_crs = 'EPSG:4326'

unproj_bbox = bbox = st_bbox(c(xmin = -16.26,
                 xmax = 42.98,
                 ymin = 27.92,
                 ymax = 61.54),
                 crs=unprojected_crs) %>%
       st_as_sfc()

bbox = unproj_bbox %>%
       st_transform(projected_crs)

cropping_bbox = vect(bbox)
up_cbbox = vect(unproj_bbox)

milan_location = st_point(c(45.4643, 9.189), dim='XY') %>%
                 st_sfc() %>%
                 as_Spatial()
crs(milan_location) = 'EPSG:3857' #NOTE: this is specifically in web mercator proj.

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
```

```{r download_and_prep_data, echo=FALSE, include=FALSE}
basemap = read_osm(bbox, type='apple-iphoto', mergeTiles=TRUE)
#should maybe project these too if i go back to that

download.file('https://a.scrunko.monster/ZIwO3/HEhiticO76.csv/raw',
              './combined-maritime-traderoutes.csv')
maritime_routes_sf = read_sf('./combined-maritime-traderoutes.csv')
st_crs(maritime_routes_sf) = unprojected_crs
maritime_routes_sf = st_transform(maritime_routes_sf, unprojected_crs) %>%
                     st_crop(unproj_bbox)

download.file('https://github.com/kgjenkins/tq-world-historical-boundaries/raw/master/1279.zip', 
              './1279_borders.zip') #download directly from an archive, as streaming from my server
                                    #crashes on windows (i think some sort of php bug on the serv.)
                                    #note: make sure to cite this archive in the bibliography!! 
unzip('./1279_borders.zip')
borders = read_sf('./cntry1279.shp')
st_crs(borders) = unprojected_crs
borders = st_transform(borders, unprojected_crs) %>%
          st_crop(unproj_bbox)

download.file('https://a.scrunko.monster/ZIwO3/Lanidubi78.asc/raw',
              './popc_1300AD.asc')
ad1300_popc_rast = rast('./popc_1300AD.asc') %>%
                   terra::project(unprojected_crs) %>%
                   crop(up_cbbox) #%>%

units(ad1300_popc_rast) = 'ppl/cell'

download.file('https://a.scrunko.monster/ZIwO3/mIMuROme20.asc/raw',
              './popd_1300AD.asc')
ad1300_popd_rast = rast('./popd_1300AD.asc') %>%
                   terra::project(unprojected_crs) %>%
                   crop(up_cbbox)

units(ad1300_popd_rast) = 'ppl/kmÂ²'

download.file('https://a.scrunko.monster/ZIwO3/CAYoYISe01.asc/raw',
              './popc_1400AD.asc')
ad1400_popc_rast = rast('./popc_1400AD.asc') %>%
                   terra::project(unprojected_crs) %>%
                   crop(up_cbbox)

units(ad1400_popc_rast) = 'ppl/cell'

download.file('https://a.scrunko.monster/ZIwO3/RiBOJiMa99.txt/raw',
              './plague-db-europe.txt')

death_raster = ad1400_popc_rast - ad1300_popc_rast
```


```{python process_plague_info, echo=FALSE}
import re
import os

if not (os.path.exists('./plague_reprocessed.json')):
  with open('./plague-db-europe.txt', 'r') as plague_data:
    plague_data_text = plague_data.read()
    processed = re.sub(r'\:([a-zA-Z]+)', r'"\1":', plague_data_text)
    processed = re.sub(r'} ', r'}, ', processed)
    with open('./plague_reprocessed.json', 'w') as outfile:
      n = outfile.write(processed)
      outfile.close()
```


```{r read_plague_info, echo=FALSE}
library(jsonlite)
library(readr)

json_raw   = readr::read_file("./plague_reprocessed.json")
json_lines = unlist(strsplit(json_raw, "\\n"))
plague_df = do.call(rbind, lapply(json_lines, #god what a hack
                                  FUN = function(x){as.data.frame(jsonlite::fromJSON(x))})) 
plague_sf = st_as_sf(x=plague_df, 
                        coords=c('lon', 'lat'),
                        crs=unprojected_crs)

plague_occurrence_ordered = plague_sf[order(plague_sf$name, plague_sf$year, decreasing=FALSE),]
plague_occurrences_by_year = plague_occurrence_ordered %>%
                            group_by(year) %>%
                            arrange(year)

first_occurrences = plague_occurrences_by_year[!duplicated(plague_occurrences_by_year$name),] %>%
                    rename(first_occurrence = year) %>%
                    data.frame() %>%
                    subset(select=-c(geometry, source))

plague_occurrences_by_year = merge(plague_occurrences_by_year, first_occurrences, by='name')

target_occurrences = plague_occurrences_by_year[which(plague_occurrences_by_year$year <= 1400),]

#thanks to baseR for the following function actually
target_occurrences['is_reoccurrence'] = duplicated(target_occurrences$name)
occurrence_count = as.data.frame(table(target_occurrences$name))
occurrence_count = rename(occurrence_count, name = Var1)
target_occurrences = merge(target_occurrences, occurrence_count, by='name', all.x=T) %>%
                          rename(n_occurrences = Freq)
#only interested in years before 1400 right now

target_occurrences = st_as_sf(target_occurrences) %>% 
                    st_crop(unproj_bbox) %>%
                    arrange(year)

all_target_years = target_occurrences[which(target_occurrences$year <= 1400),]
```


```{r garbage_collection, echo=FALSE, include=FALSE}
#just to clean up exec environment of tempvars. 
#ik if i used more piping i wouldnt have to do this, but i don't care atm
rm(plague_occurrence_ordered)
rm(plague_occurences_by_year)
rm(occurrence_count)
rm(target_occurrences)
rm(plague_df)
rm(plague_sf)
rm(json_raw)
rm(json_lines)
```


```{r test, echo=FALSE}
tm_shape(basemap) +
  tm_rgb(alpha=0.7) +
  tm_shape(ad1300_popc_rast, raster.downsample = F) +
  tm_raster(alpha=0.5, breaks=c(0.0,
                                100.0,
                                200.0,
                                400.0,
                                800.0,
                                1600.0,
                                3200.0,
                                6400.0,
                                12000.0,
                                24000.0,
                                48000.0),) +
  tm_shape(all_target_years) +
  tm_dots()
```

spatial autocorrelation in the fact that outbreaks are considered based on distance from the pixel, and that there is s.ac. in the density/count data

i *cannot* use linear population density scaling: *each cell's original size is warped by the projection*; as such, i need to obtain a per-pixel scaling value to convert pop to popd. luckily, terra has a "cellsize" function we can use to calculate


starting 1300, for each year:
- foreach pixel in population raster:
  - scale/generate r0 using known r0, distance from outbreaks, popd, prev. r0 at that pixel
  - apply this r0 and use fatality rate etc to gen. a new value at the px loc.
    - also generate a new population density for the tile.

- this does not account for migration in/out of cities as a result of population loss

-need to programmatically run this multiple times, with multiple different parameters, to compare

```{r run_simulations_1, echo=FALSE}
#not using equal-area projections, so the scaling for raster cells is spatially warped:
popc_cell_size = terra::cellSize(ad1300_popc_rast, unit='km')
#cell size shouldn't change, so we only need to do this one time
#additionally, wemust offset here, as the data used to obtain popd uses more sources than just popc
popd_offset = (ad1300_popc_rast / popc_cell_size) - ad1300_popd_rast
#so, we need to generate an offset raster representing the initial starting offset from 
#popc/cellsize present in the data, and then apply that retroactively going forward in the conv.

normalize_rast = function(rast) {
  m = terra::minmax(rast) #m[1] is min, m[2] is max
  return((rast - m[1])/(m[2] - m[1]))
}

popc2popd = function(popc_rast) {
  return((popc_rast / popc_cell_size) - popd_offset)
} #subtracting 1300_popd is valid, as that is the last known offset to the true number

year2idx = function(year) {
  return(which(recorded_years == year))
} #convenience function for converting a year number to its results-index

target_years = all_target_years[which(all_target_years$year > 1345 &
                                      all_target_years$year <= 1400),]
recorded_years = unique(target_years$year)
first_year = recorded_years[1]

d_smoothing = seq(0.40, 0.80, by=0.2) #size of the region extremely close to 1.0 in distance raster
d_coeff =     seq(6, 10, by=2) #size of the overall region above d_threshold in distance raster

worst_case =  seq(0.5, 0.9, by=0.2) #estimated maximum yearly saturation % of infection among S
mortality   = seq(0.4, 0.8, by=0.2) #estimated average mortality over all forms contracted

#non-tunable params
d_threshold = 0.01 #value at which we would like to round to 0, to prevent global infection

params = crossing(d_smoothing, d_coeff, worst_case, mortality)
iter=0
susc_maps = list()
final_dead = list()
correlations = list()
for (trial in split(params, seq(nrow(params)))) {
  iter = iter + 1
  susceptible = list()
  infected = list()
  recovered = list()
  dead = list()
  susd = list()
  maps = list()
  for (year in recorded_years) {
    curr_idx = year2idx(year) #NOT: not the idx in targ_years, just iter#
    prev_idx = curr_idx - 1
  
    prev_years_outbrks = target_years[which(target_years$year <= year),]
    curr_year_outbrks = target_years[which(target_years$year == year),]
  
    #the variable we will use to hold this year's susceptible population estimate raster
    susc_tmp = if(length(susceptible) == 0) ad1300_popc_rast else susceptible[[prev_idx]]
    
    #the variable we will use to hold this year's S population density estimate raster
    susd_tmp = normalize_rast(
      if(length(susd) == 0) ad1300_popd_rast else susd[[prev_idx]]
    )
  
    #the raster used to scale distance from an outbreak
    dist_rast = exp(1)^(-3 * normalize_rast(
      trial$d_coeff*terra::distance(susc_tmp, vect(curr_year_outbrks), rasterize=T)^trial$d_smoothing
    ))
    dist_rast[dist_rast < d_threshold] = 0
    
    #the "infectiousness raster" we can use as a term in our estimate of the number of dead/infected
    infn_rast = trial$worst_case * dist_rast * susd_tmp
    
    #the estimate of the infected. should i use terra::predict, or...?
    infected[[curr_idx]] = floor(infn_rast * susc_tmp)
    #and, the other values associated:
    susceptible[[curr_idx]] = susc_tmp - infected[[curr_idx]] #even if survived, cant be reinfected
    dead[[curr_idx]] = mortality * infected[[curr_idx]]
    recovered = infected[[curr_idx]] - dead[[curr_idx]] #R,D not really used, but hey. good 2 know
    
    #we musn't forget to also adjust the susceptible population density
    susd[[curr_idx]] = popc2popd(susceptible[[curr_idx]])
  }
  final_dead[[iter]] = terra::app(rast(dead), sum)
  
  correlations[[iter]] = cor(terra::values(ad1400_popc_rast),
                    terra::values(final_dead[[iter]]), 
                    use="complete.obs")
  plot(terra::values(final_dead[[iter]]) ~ terra::values(ad1400_popc_rast))
  abline(lm(terra::values(final_dead[[iter]]) ~ terra::values(ad1400_popc_rast)))
  legend("topleft", legend=paste('Model', iter,
                                 'Correlation =', round(correlations[[iter]], 2)))
  print(paste('trial',iter,'complete'))
}

tm_shape(basemap) +
  tm_rgb(alpha=0.8) +
  tm_shape(final_dead[[which.max(correlations)]], raster.downsample=F) +
  tm_raster(alpha=0.7, 
            breaks=c(0.0,
                     100.0,
                     200.0,
                     400.0,
                     800.0,
                     1600.0,
                     3200.0,
                     6400.0,
                     12000.0,
                     24000.0,
                     48000.0),
                     title=paste('Model',which.max(correlations),'Cumulative Dead'),legend.show=T)
```



```{r lawl}
tm_shape(basemap) + tm_rgb() + tm_shape(death_raster, raster.downsample=FALSE) + tm_raster(alpha=0.7,
                                                                  breaks=c(-51200.0
                                                                          -25600.0,
                                                                          -12800.0,
                                                                          -6400.0,
                                                                          -3200.0,
                                                                          -1600.0,
                                                                          -800.0,
                                                                          -400.0,
                                                                          -200.0,
                                                                          -100.0,
                                                                            0.0,
                                                                           100.0,
                                                                           200.0,
                                                                           400.0,
                                                                           800.0,
                                                                           1600.0)) +
        tm_shape(maritime_routes_sf) + tm_lines(col='dodgerblue', alpha=0.5) +
        tm_shape(borders$geometry) + tm_borders(alpha=0.5) + 
        tm_layout(legend.position=c("left", "top"), frame=FALSE, legend.bg.alpha=0.6, main.title='Pop. Diff 1400AD-1300AD')
```


$$
e^{-{x^{\sqrt[2]{3}}}}
$$

## Results

### Placeholder Subsection 1

### Placeholder Subsection 2

## References


<br>\
<div id="refs"></div>